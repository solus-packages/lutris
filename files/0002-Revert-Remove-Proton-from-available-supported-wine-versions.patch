From 7d2f1a8cdd2a1ccec0a06ca53f9970d8ea40d798 Mon Sep 17 00:00:00 2001
From: Mathieu Comandon <strycore@gmail.com>
Date: Wed, 2 Dec 2020 22:43:40 -0800
Subject: [PATCH] Revert "Remove Proton from available supported wine versions"

This reverts commit 0a79d761f9baae1e4513a242e67848a2fa0abcbb.
---
 lutris/runners/wine.py   | 17 ++++++++++++++---
 lutris/util/wine/wine.py |  1 +
 2 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/lutris/runners/wine.py b/lutris/runners/wine.py
index f93db45ab..9cce6e1f7 100644
--- a/lutris/runners/wine.py
+++ b/lutris/runners/wine.py
@@ -26,8 +26,8 @@
 from lutris.util.wine.wine import (
     POL_PATH, WINE_DIR, WINE_PATHS, detect_arch, display_vulkan_error, esync_display_limit_warning,
     esync_display_version_warning, fsync_display_support_warning, fsync_display_version_warning, get_default_version,
-    get_overrides_env, get_real_executable, get_system_wine_version, get_wine_versions, is_esync_limit_set,
-    is_fsync_supported, is_version_esync, is_version_fsync
+    get_overrides_env, get_proton_paths, get_real_executable, get_system_wine_version, get_wine_versions,
+    is_esync_limit_set, is_fsync_supported, is_version_esync, is_version_fsync
 )
 from lutris.util.wine.x360ce import X360ce
 
@@ -625,6 +625,10 @@ def get_path_for_version(self, version):
         # logger.debug("Getting path for Wine %s", version)
         if version in WINE_PATHS.keys():
             return system.find_executable(WINE_PATHS[version])
+        if "Proton" in version:
+            for proton_path in get_proton_paths():
+                if os.path.isfile(os.path.join(proton_path, version, "dist/bin/wine")):
+                    return os.path.join(proton_path, version, "dist/bin/wine")
         if version.startswith("PlayOnLinux"):
             version, arch = version.split()[1].rsplit("-", 1)
             return os.path.join(POL_PATH, "wine", "linux-" + arch, version, "bin/wine")
@@ -909,8 +913,15 @@ def get_runtime_env(self):
         wine_root = None
         if WINE_DIR:
             wine_root = os.path.dirname(os.path.dirname(wine_path))
+        for proton_path in get_proton_paths():
+            if proton_path in wine_path:
+                wine_root = os.path.dirname(os.path.dirname(wine_path))
+        if "-4." in wine_path or "/4." in wine_path:
+            version = "Ubuntu-18.04"
+        else:
+            version = "legacy"
         return runtime.get_env(
-            version="Ubuntu-18.04",
+            version=version,
             prefer_system_libs=self.system_config.get("prefer_system_libs", True),
             wine_path=wine_root,
         )
diff --git a/lutris/util/wine/wine.py b/lutris/util/wine/wine.py
index 0c1d8fff7..f40c96000 100644
--- a/lutris/util/wine/wine.py
+++ b/lutris/util/wine/wine.py
@@ -201,6 +201,7 @@ def get_wine_versions():
     versions = []
     versions += get_system_wine_versions()
     versions += get_lutris_wine_versions()
+    versions += get_proton_versions()
     versions += get_pol_wine_versions()
     return versions
 
